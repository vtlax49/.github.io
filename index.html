<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ES RTH Gap-Fill Dashboard</title>
  <style>
    body   { font-family: system-ui, sans-serif; margin: 2rem; max-width: 800px; }
    h1,h2  { margin: .2rem 0 .6rem 0; }
    table  { border-collapse: collapse; width: 100%; margin: 1.2rem 0; }
    th,td  { border: 1px solid #ccc; padding: 6px 8px; text-align: center; }
    th     { background:#f3f3f3; }
    caption{ margin-bottom:.4rem; font-weight:600; text-align:left; }
    .error { color:red; }
  </style>
</head>
<body>
<h1>RTH Gap-Fill Statistics (ES Futures)</h1>
<p id="status">Loading data…</p>

<!-- ── SUMMARY TABLE: overall vs last-30 trading days ────────────────────── -->
<table id="tbl-summary" hidden>
  <caption>Overall vs Last 30 Trading Days</caption>
  <thead>
    <tr><th rowspan="2"></th><th colspan="2">Half-Gap Fill</th><th colspan="2">Full-Gap Fill</th></tr>
    <tr><th>Count</th><th>%</th><th>Count</th><th>%</th></tr>
  </thead>
  <tbody></tbody>
</table>

<!-- ── WEEKDAY TABLE: overall + 30-day side-by-side ──────────────────────── -->
<table id="tbl-weekday" hidden>
  <caption>By Weekday (overall & last 30 trading days)</caption>
  <thead>
    <tr><th rowspan="2">Week-day</th><th colspan="2">Half-Gap Fill</th><th colspan="2">Full-Gap Fill</th></tr>
    <tr><th>All</th><th>30d</th><th>All</th><th>30d</th></tr>
  </thead>
  <tbody></tbody>
</table>

<script type="module">
const pct = (num, den) => den ? (100 * num / den).toFixed(1) + '%' : '—';
const weekdayNames = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];

async function loadGapData() {
  try {
    const res = await fetch('./es_gapfills.json');
    if (!res.ok) throw new Error(res.status + ' ' + res.statusText);
    const data = await res.json();
    buildSummaryTables(data);
    document.getElementById('status').hidden = true;
  } catch (err) {
    const st = document.getElementById('status');
    st.textContent = '⚠️ ' + err.message + ' — is es_gapfills.json present?';
    st.className = 'error';
    console.error(err);
  }
}

function buildSummaryTables(rows) {
  const last30 = rows.slice(-30);
  // --- Overall vs 30-day table -------------------------------------------
  const sums = [
    { label:'Overall',  set: rows },
    { label:'Last 30',  set: last30 }
  ];

  const bodySum = document.querySelector('#tbl-summary tbody');
  sums.forEach(({label,set})=>{
    const total = set.length;
    const half  = set.filter(r=>r.half_gap_filled).length;
    const full  = set.filter(r=>r.full_gap_filled).length;
    bodySum.insertAdjacentHTML('beforeend', `
      <tr>
        <td style="text-align:left">${label}</td>
        <td>${half}</td><td>${pct(half,total)}</td>
        <td>${full}</td><td>${pct(full,total)}</td>
      </tr>
    `);
  });
  document.getElementById('tbl-summary').hidden = false;

  // --- Weekday table ------------------------------------------------------
  const bodyWd = document.querySelector('#tbl-weekday tbody');
  ['Mon','Tue','Wed','Thu','Fri'].forEach((wd,i)=>{
    const allSet  = rows   .filter(r=>new Date(r.date).getDay()===i+1); // +1 because 0=Sun
    const d30Set  = last30 .filter(r=>new Date(r.date).getDay()===i+1);

    const totalA  = allSet.length,   halfA = allSet.filter(r=>r.half_gap_filled).length,
          fullA   = allSet.filter(r=>r.full_gap_filled).length;
    const totalB  = d30Set.length,   halfB = d30Set.filter(r=>r.half_gap_filled).length,
          fullB   = d30Set.filter(r=>r.full_gap_filled).length;

    bodyWd.insertAdjacentHTML('beforeend', `
      <tr>
        <td style="text-align:left">${wd}</td>
        <td>${pct(halfA,totalA)}</td><td>${pct(halfB,totalB)}</td>
        <td>${pct(fullA,totalA)}</td><td>${pct(fullB,totalB)}</td>
      </tr>
    `);
  });
  document.getElementById('tbl-weekday').hidden = false;
}

loadGapData();
</script>

<noscript><p class="error">This page needs JavaScript to display data.</p></noscript>
</body>
</html>
