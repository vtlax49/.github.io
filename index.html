<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ES RTH Gap-Fill Dashboard</title>

  <!-- Tailwind CSS ‚Äì just a CDN link, no build step -->
  <script src="https://cdn.tailwindcss.com/3.4.4"></script>

  <!-- Fav icon & meta ----------------------------------------------------->
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22
        viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìà</text></svg>">

  <!-- Custom tweaks ------------------------------------------------------->
  <style>
    body{
      @apply bg-gradient-to-tr from-indigo-700 via-blue-700 to-sky-600
             text-white min-h-screen antialiased;
    }
    /* glass card */
    .glass{
      @apply bg-white/10 backdrop-blur-sm rounded-2xl shadow-md p-6
             ring-1 ring-white/20;
    }
    table{
      @apply w-full text-sm sm:text-base;
    }
    th{
      @apply px-3 py-2 border-b border-white/20 bg-white/10 uppercase tracking-wide;
    }
    td{
      @apply px-3 py-1 border-b border-white/10 text-center;
    }
    tr:hover td{ @apply bg-white/5 transition; }
    .badge{ @apply inline-block min-w-[3rem] rounded-full px-2 py-0.5;
            font-variant-numeric: tabular-nums; }
    .ok   { @apply badge bg-emerald-500/90 }
    .fail { @apply badge bg-rose-500/90  }
  </style>
</head>

<body class="flex flex-col items-center px-4 sm:px-6">

  <header class="max-w-3xl w-full mt-8 mb-6 text-center glass">
    <h1 class="text-3xl sm:text-4xl font-bold tracking-tight">ES Futures ‚Äì RTH Gap Fill Stats</h1>
    <p class="mt-1 text-sm sm:text-base text-white/80">
      Updated automatically with 15-minute data from yfinance
    </p>
  </header>

  <!-- STATUS message -->
  <p id="status" class="glass w-full max-w-3xl text-center mb-6">Loading data‚Ä¶</p>

  <!-- SUMMARY ------------------------------------------------------------->
  <section id="card-summary" class="glass w-full max-w-3xl mb-6 hidden">
    <h2 class="text-xl font-semibold mb-3">Overall vs Last 30 Trading Days</h2>
    <div class="overflow-x-auto">
      <table id="tbl-summary"></table>
    </div>
  </section>

  <!-- WEEKDAY ------------------------------------------------------------->
  <section id="card-wd" class="glass w-full max-w-3xl mb-6 hidden">
    <h2 class="text-xl font-semibold mb-3">Weekday Breakdown</h2>
    <div class="overflow-x-auto">
      <table id="tbl-weekday"></table>
    </div>
  </section>

  <!-- DAILY DETAIL -------------------------------------------------------->
  <section id="card-detail" class="glass w-full max-w-5xl mb-12 hidden">
    <h2 class="text-xl font-semibold mb-3">Daily Results (latest first)</h2>
    <div class="overflow-x-auto">
      <table id="tbl-detail" class="text-sm"></table>
    </div>
  </section>

<!-- ===================================================================== -->
<script type="module">
const pct = (n,d)=>d?(100*n/d).toFixed(1)+'%':'‚Äî';
const wd = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

function dayIdx(str){ return new Date(str+'T12:00').getDay(); }

function calc(set){
  const gaps = set.filter(r=>r.gap!==0);
  const t = gaps.length;
  return {t, h:gaps.filter(x=>x.half_gap_filled).length,
              f:gaps.filter(x=>x.full_gap_filled).length};
}

/* ---------------- build html helpers ---------------------------------- */
function buildSummary(rows){
  const last30=rows.slice(-30);
  const parts=[['Overall',rows],['Last 30',last30]];
  const head=`
    <thead><tr><th></th><th colspan="2">Half Fill</th><th colspan="2">Full Fill</th></tr>
           <tr><th></th><th>Count</th><th>%</th><th>Count</th><th>%</th></tr></thead>`;
  const body=parts.map(([lbl,set])=>{
    const {t,h,f}=calc(set);
    return `<tr><td class="text-left">${lbl}</td>
      <td>${h}</td><td>${pct(h,t)}</td><td>${f}</td><td>${pct(f,t)}</td></tr>`;
  }).join('');
  document.getElementById('tbl-summary').innerHTML=head+'<tbody>'+body+'</tbody>';
  document.getElementById('card-summary').classList.remove('hidden');
}

function buildWeekday(rows){
  const last30=rows.slice(-30);
  const head=`<thead>
    <tr><th rowspan="2">Week-day</th><th colspan="2">Half Fill %</th><th colspan="2">Full Fill %</th></tr>
    <tr><th>All</th><th>30d</th><th>All</th><th>30d</th></tr></thead>`;
  const body=['Mon','Tue','Wed','Thu','Fri'].map(w=>{
    const idx = wd.indexOf(w);
    const a=rows .filter(r=>dayIdx(r.date)===idx);
    const b=last30.filter(r=>dayIdx(r.date)===idx);
    const {t:ta,h:ha,f:fa}=calc(a);
    const {t:tb,h:hb,f:fb}=calc(b);
    return `<tr><td class="text-left">${w}</td>
      <td>${pct(ha,ta)}</td><td>${pct(hb,tb)}</td>
      <td>${pct(fa,ta)}</td><td>${pct(fb,tb)}</td></tr>`;
  }).join('');
  document.getElementById('tbl-weekday').innerHTML=head+'<tbody>'+body+'</tbody>';
  document.getElementById('card-wd').classList.remove('hidden');
}

function buildDaily(rows){
  const head=`<thead>
    <tr><th>Date</th><th>Prev Close</th><th>09:30 Open</th><th>Gap</th>
        <th>¬Ω Filled?</th><th>Full Filled?</th></tr></thead>`;
  const body=rows.slice().reverse().map(r=>`
    <tr>
      <td class="text-left">${r.date}</td>
      <td>${r.prev_close.toFixed(2)}</td>
      <td>${r.open_0930.toFixed(2)}</td>
      <td>${r.gap.toFixed(2)}</td>
      <td>${r.half_gap_filled?'<span class="ok">‚úÖ</span>':'<span class="fail">‚úñ</span>'}</td>
      <td>${r.full_gap_filled?'<span class="ok">‚úÖ</span>':'<span class="fail">‚úñ</span>'}</td>
    </tr>`).join('');
  document.getElementById('tbl-detail').innerHTML=head+'<tbody>'+body+'</tbody>';
  document.getElementById('card-detail').classList.remove('hidden');
}

/* ---------------- fetch + render -------------------------------------- */
(async()=>{
  try{
    const res=await fetch('./es_gapfills.json');
    if(!res.ok) throw new Error(res.status);
    const data=await res.json();
    buildSummary(data);
    buildWeekday(data);
    buildDaily(data);
    document.getElementById('status').remove();
  }catch(err){
    const s=document.getElementById('status');
    s.textContent='‚ö†Ô∏è  '+err+' ‚Äî es_gapfills.json missing?';
    s.classList.add('text-red-200');
  }
})();
</script>
<noscript><p class="text-red-200">Enable JavaScript to view the dashboard.</p></noscript>
</body>
</html>
