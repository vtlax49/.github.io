<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ES RTH Gap-Fill Dashboard</title>
  <style>
    body{font-family:system-ui,sans-serif;margin:2rem;max-width:980px}
    h1,h2{margin:.2rem 0 .6rem}
    table{border-collapse:collapse;width:100%;margin:1.2rem 0;font-size:.95rem}
    th,td{border:1px solid #ccc;padding:6px 8px;text-align:center}
    th{background:#f3f3f3}
    caption{margin-bottom:.4rem;font-weight:600;text-align:left}
    .error{color:red}
  </style>
</head>
<body>
<h1>RTH Gap-Fill Statistics ‚Äî ES Futures</h1>
<p id="status">Loading data‚Ä¶</p>

<!-- SUMMARY ---------------------------------------------------------------->
<table id="tbl-summary" hidden>
  <caption>Overall vs Last 30 Trading Days <small>(zero-gap days excluded)</small></caption>
  <thead>
    <tr><th rowspan="2"></th><th colspan="2">Half-Gap Fill</th><th colspan="2">Full-Gap Fill</th></tr>
    <tr><th>Count</th><th>%</th><th>Count</th><th>%</th></tr>
  </thead>
  <tbody></tbody>
</table>

<!-- WEEKDAY ---------------------------------------------------------------->
<table id="tbl-weekday" hidden>
  <caption>By Weekday (zero-gap days excluded)</caption>
  <thead>
    <tr><th rowspan="2">Week-day</th><th colspan="2">Half-Gap Fill %</th><th colspan="2">Full-Gap Fill %</th></tr>
    <tr><th>All</th><th>30d</th><th>All</th><th>30d</th></tr>
  </thead>
  <tbody></tbody>
</table>

<!-- DAILY DETAIL ----------------------------------------------------------->
<table id="tbl-detail" hidden>
  <caption>Daily Gap-Fill Results (most-recent first)</caption>
  <thead>
    <tr>
      <th>Date</th><th>Prev Close (16:00)</th><th>09‚Äâ:‚Äâ30 Open</th>
      <th>Gap</th><th>¬Ω Filled?</th><th>Full Filled?</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script type="module">
const pct=(n,d)=>d?(100*n/d).toFixed(1)+'%':'‚Äî';
const wdNames=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

function dayIndex(dateStr){
  // üëâ NEW: use noon local time so timezone offset can‚Äôt push us to prior day
  return new Date(dateStr+'T12:00').getDay();
}

function calcStats(set){
  const gaps=set.filter(r=>r.gap!==0);
  return {
    total:gaps.length,
    half:gaps.filter(r=>r.half_gap_filled).length,
    full:gaps.filter(r=>r.full_gap_filled).length
  };
}

function buildTables(rows){
  const last30=rows.slice(-30);

  /* summary */
  const sBody=document.querySelector('#tbl-summary tbody');
  [{label:'Overall',set:rows},{label:'Last 30',set:last30}].forEach(({label,set})=>{
    const {total,half,full}=calcStats(set);
    sBody.insertAdjacentHTML('beforeend',`
      <tr><td style="text-align:left">${label}</td>
          <td>${half}</td><td>${pct(half,total)}</td>
          <td>${full}</td><td>${pct(full,total)}</td></tr>`);
  });
  document.getElementById('tbl-summary').hidden=false;

  /* weekday */
  const wBody=document.querySelector('#tbl-weekday tbody');
  ['Mon','Tue','Wed','Thu','Fri'].forEach(wd=>{
    const idx=wdNames.indexOf(wd);
    const all=rows .filter(r=>dayIndex(r.date)===idx);
    const d30=last30.filter(r=>dayIndex(r.date)===idx);

    const {total:ta,half:ha,full:fa}=calcStats(all);
    const {total:tb,half:hb,full:fb}=calcStats(d30);

    wBody.insertAdjacentHTML('beforeend',`
      <tr><td style="text-align:left">${wd}</td>
          <td>${pct(ha,ta)}</td><td>${pct(hb,tb)}</td>
          <td>${pct(fa,ta)}</td><td>${pct(fb,tb)}</td></tr>`);
  });
  document.getElementById('tbl-weekday').hidden=false;

  /* daily detail */
  const dBody=document.querySelector('#tbl-detail tbody');
  rows.slice().reverse().forEach(r=>{
    dBody.insertAdjacentHTML('beforeend',`
      <tr>
        <td style="text-align:left">${r.date}</td>
        <td>${r.prev_close.toFixed(2)}</td>
        <td>${r.open_0930.toFixed(2)}</td>
        <td>${r.gap.toFixed(2)}</td>
        <td>${r.half_gap_filled?'‚úÖ':'‚ùå'}</td>
        <td>${r.full_gap_filled?'‚úÖ':'‚ùå'}</td>
      </tr>`);
  });
  document.getElementById('tbl-detail').hidden=false;
}

/* fetch + render */
(async()=>{
  try{
    const res=await fetch('./es_gapfills.json');
    if(!res.ok) throw new Error(res.status+' '+res.statusText);
    buildTables(await res.json());
    document.getElementById('status').hidden=true;
  }catch(err){
    const s=document.getElementById('status');
    s.textContent='‚ö†Ô∏è '+err.message+' ‚Äî is es_gapfills.json present?';
    s.className='error';
    console.error(err);
  }
})();
</script>

<noscript><p class="error">This page needs JavaScript to display data.</p></noscript>
</body>
</html>
