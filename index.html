<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ES RTH Gap-Fill Dashboard</title>
  <style>
    body   { font-family: system-ui, sans-serif; margin: 2rem; max-width: 900px; }
    h1,h2  { margin: .2rem 0 .6rem 0; }
    table  { border-collapse: collapse; width: 100%; margin: 1.2rem 0; }
    th,td  { border: 1px solid #ccc; padding: 6px 8px; text-align: center; }
    th     { background:#f3f3f3; }
    caption{ margin-bottom:.4rem; font-weight:600; text-align:left; }
    .error { color:red; }
  </style>
</head>
<body>
<h1>RTH Gap-Fill Statistics — ES Futures</h1>
<p id="status">Loading data…</p>

<!-- SUMMARY: overall vs last-30 trading days -------------------------------->
<table id="tbl-summary" hidden>
  <caption>Overall vs Last 30 Trading Days <small>(zero-gap days excluded)</small></caption>
  <thead>
    <tr><th rowspan="2"></th><th colspan="2">Half-Gap Fill</th><th colspan="2">Full-Gap Fill</th></tr>
    <tr><th>Count</th><th>%</th><th>Count</th><th>%</th></tr>
  </thead>
  <tbody></tbody>
</table>

<!-- WEEKDAY breakdown ------------------------------------------------------->
<table id="tbl-weekday" hidden>
  <caption>By Weekday (zero-gap days excluded)</caption>
  <thead>
    <tr><th rowspan="2">Week-day</th><th colspan="2">Half-Gap Fill&nbsp;%</th><th colspan="2">Full-Gap Fill&nbsp;%</th></tr>
    <tr><th>All</th><th>30d</th><th>All</th><th>30d</th></tr>
  </thead>
  <tbody></tbody>
</table>

<!-- DAILY DETAIL table (✅ / ❌) ------------------------------------------->
<table id="tbl-detail" hidden>
  <caption>Daily Gap-Fill Results (most-recent first)</caption>
  <thead>
    <tr>
      <th>Date</th><th>Gap</th><th>½&nbsp;Filled?</th><th>Full&nbsp;Filled?</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script type="module">
const pct = (num, den) => den ? (100 * num / den).toFixed(1) + '%' : '—';
const weekdayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

/* ---------------- helpers ------------------------------------------------ */
function calcStats(set){
  const gaps      = set.filter(r => r.gap !== 0);
  const total     = gaps.length;
  const halfFills = gaps.filter(r => r.half_gap_filled).length;
  const fullFills = gaps.filter(r => r.full_gap_filled ).length;
  return { total, halfFills, fullFills };
}

/* ---------------- build tables ------------------------------------------ */
function buildTables(rows){
  const last30 = rows.slice(-30);               // last 30 trading days

  /* -- SUMMARY (overall vs 30-day) --------------------------------------- */
  const buckets = [
    { label:'Overall', set:rows },
    { label:'Last 30', set:last30 }
  ];
  const bodySum = document.querySelector('#tbl-summary tbody');
  buckets.forEach(({label,set})=>{
    const {total, halfFills, fullFills} = calcStats(set);
    bodySum.insertAdjacentHTML('beforeend',`
      <tr>
        <td style="text-align:left">${label}</td>
        <td>${halfFills}</td><td>${pct(halfFills,total)}</td>
        <td>${fullFills}</td><td>${pct(fullFills,total)}</td>
      </tr>
    `);
  });
  document.getElementById('tbl-summary').hidden = false;

  /* -- WEEKDAY breakdown -------------------------------------------------- */
  const bodyWd = document.querySelector('#tbl-weekday tbody');
  ['Mon','Tue','Wed','Thu','Fri'].forEach(wd=>{
    const idx       = weekdayNames.indexOf(wd);   // 1-5
    const allSet    = rows  .filter(r => new Date(r.date).getDay() === idx);
    const last30Set = last30.filter(r => new Date(r.date).getDay() === idx);

    const {total:ta, halfFills:ha, fullFills:fa} = calcStats(allSet);
    const {total:tb, halfFills:hb, fullFills:fb} = calcStats(last30Set);

    bodyWd.insertAdjacentHTML('beforeend',`
      <tr>
        <td style="text-align:left">${wd}</td>
        <td>${pct(ha,ta)}</td><td>${pct(hb,tb)}</td>
        <td>${pct(fa,ta)}</td><td>${pct(fb,tb)}</td>
      </tr>
    `);
  });
  document.getElementById('tbl-weekday').hidden = false;

  /* -- DAILY DETAIL table ------------------------------------------------- */
  const bodyDetail = document.querySelector('#tbl-detail tbody');
  rows.slice().reverse().forEach(r=>{
    bodyDetail.insertAdjacentHTML('beforeend',`
      <tr>
        <td style="text-align:left">${r.date}</td>
        <td>${r.gap.toFixed(2)}</td>
        <td>${r.half_gap_filled ? '✅' : '❌'}</td>
        <td>${r.full_gap_filled ? '✅' : '❌'}</td>
      </tr>
    `);
  });
  document.getElementById('tbl-detail').hidden = false;
}

/* ---------------- fetch & render ---------------------------------------- */
(async ()=>{
  try{
    const res = await fetch('./es_gapfills.json');
    if(!res.ok) throw new Error(res.status+' '+res.statusText);
    const data = await res.json();
    buildTables(data);
    document.getElementById('status').hidden = true;
  }catch(err){
    const st=document.getElementById('status');
    st.textContent='⚠️ '+err.message+' — is es_gapfills.json present?';
    st.className='error';
    console.error(err);
  }
})();
</script>

<noscript><p class="error">This page needs JavaScript to display data.</p></noscript>
</body>
</html>
